<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>Council District Map</title>
  <link rel="stylesheet" type="text/css" href="http://js.arcgis.com/3.8/js/esri/css/esri.css"> 
  <!-- Load the library references for ArcGIS API for JavaScript -->
  <script src="http://js.arcgis.com/3.8compact"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" ></script>
  <style>
    html, body, #map {
      padding:0;
      margin:0;
      height:100%;
    }
    #HomeButton {
      position: absolute;
      top: 95px;
      left: 20px;
      z-index: 50;
    }
  </style>
  <script>
    require(["esri/map", 
      "esri/dijit/Geocoder", 
      "esri/InfoTemplate",
      "esri/layers/FeatureLayer", 
      "esri/graphic", 
      "esri/geometry/Multipoint",
      "esri/symbols/TextSymbol",
      "esri/renderers/SimpleRenderer",
      "esri/layers/LabelLayer",
      "./js/utils.js", 
      "./js/bootstrapmap.js",
      "dojo/dom", 
      "dojo/on", 
      "dojo/domReady!"], 
      function(Map, Geocoder, InfoTemplate, FeatureLayer, Graphic, Multipoint, TextSymbol, SimpleRenderer, LabelLayer, utils, BootstrapMap, dom, on) {             
        "use strict"
        
        // Create map
        var map = BootstrapMap.create("mapDiv",{
          basemap:"national-geographic",
          center: [-120.54, 46.59],
          zoom: 13
        });
        
        var labelField = "District";
        //council districts
        var districts = new FeatureLayer("https://gis.yakimawa.gov/arcgis101/rest/services/General/YakimaLayers/MapServer/11",{
          outFields: ["District"],
          opacity:.60
        });
        map.addLayer(districts);
        
        // create a text symbol to define the style of labels
        var districtLabel = new TextSymbol().setColor("#555");
        districtLabel.font.setSize("250%");
        districtLabel.font.setFamily("arial");
        var districtLabelRenderer = new SimpleRenderer(districtLabel);
        
        var labels = new LabelLayer({ id: "labels" });
        // tell the label layer to label the countries feature layer 
        // using the field named "admin"
        labels.addFeatureLayer(districts, districtLabelRenderer, "${" + labelField + "}");
        // add the label layer to the map
        map.addLayer(labels);
        
        //city limits
        var cityLimits = new FeatureLayer("https://gis.yakimawa.gov/arcgis101/rest/services/General/YakimaLayers/MapServer/9",{
          outFields: ["*"]
        });
        map.addLayer(cityLimits);

        utils.setPopup(map, "top", -1, 26);
        utils.autoRecenter(map);

        var sym = utils.createPictureSymbol("./images/blue-pin.png", 0, 12, 13, 24);
        
        // Create widget
        var locatorUrl = "https://gis.yakimawa.gov/arcgis101/rest/services/Geocode/Composite/GeocodeServer";
        var myGeocoders = [{
          url: locatorUrl,
          name: "YakimaGeocoder"
        }];
        var geocoder = new Geocoder({
          autoNavigate: false,
          maxLocations: 25,
          autoComplete: true,
          arcgisGeocoder: false,
          geocoders: myGeocoders,
          map: map
        },"search");        
        geocoder.startup();

        // Wire events
        on(map, "load", function() {
          geocoder.on("select", geocodeSelect);
          geocoder.on("findResults", geocodeResults);
          geocoder.on("clear", clearFindGraphics);
          // Wire UI events
          on(dom.byId("btnGeosearch"),"click", geosearch);
          on(dom.byId("btnClear"),"click", clearFindGraphics);
        });
         
        function geosearch() {
          var def = geocoder.find();
          def.then(function(res){
           geocodeResults(res);
          });
        }
        
        function geocodeResults(places) {
          // Translate features to places...
          places = places.results;
          if (places.length > 0) {
            clearFindGraphics();
            // Objects for the graphic
            var symbol = sym;
            // Create and add graphics with pop-ups
            for (var i = 0; i < places.length; i++) {
              addPlaceGraphic(places[i], symbol);
            }
            // Zoom to results
            zoomToPlaces(places);
          } else {
            alert("Sorry, address or place not found.");
          }
        }

        function geocodeSelect(item) {
          // Create and add a selected graphic with pop-up
          var g = (item.graphic ? item.graphic : item.result.feature);
          g.setSymbol(sym);
          //clearFindGraphics();
          addPlaceGraphic(item.result,g.symbol);
        }

        function addPlaceGraphic(item,symbol)  {
          var place = {};
          var attributes,infoTemplate,pt,graphic;
          pt = item.feature.geometry;
          place.address = item.name;
          place.score = item.feature.attributes.Score;
          // Graphic components
          attributes = { address:place.address, score:place.score, lat:pt.getLatitude().toFixed(2), lon:pt.getLongitude().toFixed(2) };   
          infoTemplate = new InfoTemplate("Geocode Result","${address}<br/>Latitude: ${lat}<br/>Longitude: ${lon}<br/>Score: ${score}");
          graphic = new Graphic(pt,symbol,attributes,infoTemplate);
          // Add to map
          map.graphics.add(graphic);  
        }
                  
        function zoomToPlaces(places) {
          var multiPoint = new Multipoint(map.spatialReference);
          for (var i = 0; i < places.length; i++) {
            //multiPoint.addPoint(places[i].location);
            multiPoint.addPoint(places[i].feature.geometry);
          }
          map.setExtent(multiPoint.getExtent().expand(2.0));
        }

        function clearFindGraphics() {
          map.infoWindow.hide();
          map.graphics.clear();
        }
      }
    );    
  </script>
</head>
<body>
  <div class="panel">
    <div class="titlearea"><span id="titleMessage" class="title-message">Find Places Widget</span></div>
    <div class="controls">
      <div class="buttons">       
        <span class="controls-inner">
        <div id="search"></div>
        <!--label><input id="useMapExtent" type="checkbox" checked/>Search in map only</label--> 
        <button class="btn btn-primary" id="btnGeosearch">Go</button>
        <button class="btn" id="btnClear">Clear</button>
        </span>
      </div>
    </div>
  </div>
  <div id="progress" class="progress hidden"></div>
  <div id="mapDiv"></div>  
</body>
</html>
